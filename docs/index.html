<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>Matters式金句貼製造機</title>
    <style>
        body {
            font-family: sans-serif;
            font-size: 16px;
            max-width: 800px;
            margin: 0 auto;
        }

        .matters-logo {
            display: block;
            width: 150px;
            margin: 0 auto;
            z-index: 1;
        }

        #date {
            float: right;
        }

        .output {
            position: relative;
            max-width: 368px;
            border: 1px solid black;
            padding: 100px;
        }

        .quote-mark {
            position: absolute;
            width: 50px;
            top: 197px;
            z-index: -1;
            left: 70px;
        }

        .dark .quote-mark {
            opacity: 0.3;
            z-index: 1;
        }

        .byline {
            text-align: right;
        }

        #author-name {
            text-align: right;
        }

        #section, #date, .byline {
            color: #9F8144;
        }

        .head {
            font-size: 1.1rem;
        }

        #content {
            font-size: 18px;
            font-family: serif;
            line-height: 2;
        }

        .output img.dark {
            display: none;
        }

        .output.dark img.dark {
            display: block;
        }

        .output.dark img.bright {
            display: none;
        }

        .output.dark {
            background: #444;
        }

        .output.dark #content {
            color: white;
        }

        .output.dark #today {
            color: white;
        }

        .qrcode {
            position: absolute;
            width: 73px;
            bottom: 77px;
            left: 8px;
        }

        .qrcode-default-image {
            width: 100%;
        }

        .qrcode-generated {
            padding: 2px;
        }

        .screenshot {
            display: inline-block;
            margin: 0.2rem 0.5rem;
            text-decoration: underline;
            cursor: pointer;
            color: #00A;
        }

        .screenshot:first-of-type {
            font-size: 1.5rem;
        }

        .entry {
            display: flex;
            flex-direction: row;
            align-items: baseline;
            margin: 0.5rem 0;
            width: 100%;
        }

        .entry input, .entry textarea {
            font-size: 0.9rem;
            flex: 1;
            border: 1px solid #ccc;
        }

        input:hover, textarea:hover {
            border: 1px solid black;
        }

        label:hover {
            background: #eee;
        }

        .description {
            margin-right: 0.5rem;
            font-weight: bold;
        }

        .description:not(:first-of-type) {
            margin-left: 1rem;
        }

        .customization-options {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in;
        }

        .customization-switch {
            font-weight: bold;
            cursor: pointer;
        }

        .customizing .customization-options {
            max-height: 200px;
        }

        .customization-marker {
            display: inline-block;
            transform: rotate(0);
            transition: transform 0.2s ease-in;
        }

        .customizing .customization-marker {
            transform: rotate(90deg);
        }

    </style>
</head>
<body>
    <div class="entry">
        <span class="description">主題</span>
        <input class="section-input" value="跨界">
        <span class="description">日期</span>
        <input class="date-input" value="2019.04.26">
    </div>
    <div class="entry">
        <span class="description">引文</span>
        <textarea class="content-input">透过极小的团队合作，以我作为一个个体记者的视角，用重现场、长特写的方法来写故事，并且能隐约指向更大的讨论，依然是我能找到的、我最有动力继续下去的“媒介”。我自己，去画一个没有疆域、或是跨越了疆域的世界。 </textarea>
    </div>
    <div class="entry">
        <span class="description">作者</span>
        <input class="author-name-input" value="甯卉">
        <span class="description">標題</span>
        <input class="title-input" value="跨境记者第六年，一个人的国际新闻地图">
    </div>
    <div class="customization-panel">
        <div class="customization-switch">
            <span class="customization-marker">▶</span>微調
        </div>
        <div class="customization-options">
            <div class="entry">
                <span class="description">引文字體</span>
                <span class="content-ff-chooser">
                <label>
                    <input type="radio" name="content-ff" value="system-serif" checked="checked" />系統襯線體
                </label>

                <label>
                    <input type="radio" name="content-ff" value="ming"/>明體
                </label>

                <label>
                    <input type="radio" name="content-ff" value="hei">黑體
                </label>

                <label>
                    <input type="radio" name="content-ff" value="kai">楷體
                </label>

                <label>
                    <input type="radio" name="content-ff" value="fangsong">仿宋
                </label>

                <label>
                    <input type="radio" name="content-ff" value="custom">自定義
                </label>
                <input class="content-ff-custom-input" disabled="disabled" value="STFangsong" />
        </span>
            </div>
            <div class="entry">
                <span class="description">引文文字大小</span>
                <span class="content-fs-chooser">
                <label>
                    <input class="content-fs-auto-switch" type="checkbox" checked="checked" />
                    自動縮放
                </label>
                <input class="content-fs-input" type="number" value="18" />px
        </span>
            </div>
            <div class="entry">
                <span class="description">色調</span>
                <span class="palette-chooser">
            <label>
                <input type="radio" name="palette" value="bright" checked="checked">日
            </label>

            <label>
                <input type="radio" name="palette" value="dark">夜
            </label>
        </span>
            </div>
            <div class="entry">
                <div>
                    <input class="qrcode-check" type="checkbox" checked="checked">
                    <span>QRCode</span>
                    <input class="qrcode-custom" type="text" placeholder="自定義QRCode">
                    <button class="qrcode-switch">替換</button>
                </div>
            </div>
        </div>
    </div>
    <div class="entry">
        <a class="screenshot" data-resolution="2K">下載截圖</a>
        <a class="screenshot" data-resolution="8K">(下載8K高清版)</a>
    </div>

    <div class="output">
        <img class="matters-logo bright" src="./assets/matters-logo.png">
        <img class="matters-logo dark" src="./assets/matters-logo-dark.png">
        <div>
            <div class="head">
                <span id="today">今日</span>
                <span id="section"></span>
                <span id="date"></span>
            </div>
            <p id="content"></p>
            <img class="quote-mark" src="./assets/quote-mark.png">
            <div class="byline">
                <div id="author-name"></div>
                <div id="title"></div>
            </div>

            <div class="qrcode">
                <img class="qrcode-default-image" src="./assets/qrcode.png">
                <div class="qrcode-generated" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script src="./vendor/html2canvas.min.js"></script>
<script src="./vendor/qrcode.min.js"></script>

<script>
    const fontFamilyKey = "ff";
    const fontFamilyCustomKey = "ff-custom";

    function saveSettings() {
        const activatedFontFamily = document.querySelector(".content-ff-chooser input:checked").value;
        const customFontFamily = document.querySelector(".content-ff-custom-input").value;
        localStorage.setItem(fontFamilyKey, activatedFontFamily);
        localStorage.setItem(fontFamilyCustomKey, customFontFamily);
    }

    function loadSettings() {
        const savedFontFamily = localStorage.getItem(fontFamilyKey);
        if (savedFontFamily) {
            document.querySelectorAll(".content-ff-chooser input").forEach(node => {
                node.checked = node.value === savedFontFamily;
            })
            if (savedFontFamily === "custom") {
                document.querySelector(".content-ff-custom-input").removeAttribute("disabled");
            }
        }
        const savedCustomFontFamily = localStorage.getItem(fontFamilyCustomKey);
        if (savedCustomFontFamily) {
            document.querySelector(".content-ff-custom-input").value = savedCustomFontFamily;
        }
    }

    function trySilently(f) {
        return function() {
            try {
                f()
            } catch (error) { }
        }
    }

    const trySaveSettings = trySilently(saveSettings);
    const tryLoadSettings = trySilently(loadSettings);

    tryLoadSettings();

    function render() {
        for (const s of ["section", "date", "content", "author-name", "title"]) {
            document.querySelector(`#${s}`).innerHTML = document.querySelector(`.${s}-input`).value;
        }
    }
    render();

    document.querySelector(".section-input").addEventListener("input", event => {
        document.querySelector("#section").innerHTML = event.target.value;
    });

    document.querySelector(".date-input").addEventListener("input", event => {
        document.querySelector("#date").innerHTML = event.target.value;
    });

    document.querySelector(".content-input").addEventListener("input", event => {
        document.querySelector("#content").innerHTML = event.target.value;

        if (document.querySelector(".content-fs-auto-switch").checked) {

            autoSetContentSize();
        }
    });

    document.querySelector(".author-name-input").addEventListener("input", event => {
        document.querySelector("#author-name").innerHTML = event.target.value;
    });

    document.querySelector(".title-input").addEventListener("input", event => {
        document.querySelector("#title").innerHTML = event.target.value;
    });

    document.querySelector(".palette-chooser").addEventListener("click", event => {
        event.stopPropagation();
        if (event.target.value === "bright") {
            document.querySelector(".output").classList.remove("dark");
        }
        else {
            document.querySelector(".output").classList.add("dark");
        }
    });

    document.querySelector(".qrcode-check").addEventListener("change", event => {
        if (event.target.checked) {
            document.querySelector(".qrcode").style.display = "block";
        }
        else {
            document.querySelector(".qrcode").style.display = "none";
        }
    });

    document.querySelectorAll(".screenshot").forEach(node => node.addEventListener("click", event => {
        const scaleKilo = Number.parseInt(event.target.getAttribute("data-resolution"), 10) || 2;
        const scale = Math.round(scaleKilo * 2);
        html2canvas(document.querySelector(".output"), {scale}).then(canvas => {
            const image = canvas.toDataURL("image/png", 1.0);
            const link = document.createElement('a');
            link.download = `${document.querySelector(".title-input").value}.png`;
            link.href = image;
            link.click();
        });
    }));


    let qrcodeInstance = null;
    document.querySelector(".qrcode-switch").addEventListener("click", () => {
        const url = document.querySelector(".qrcode-custom").value;
        if (!qrcodeInstance) {
            try {
                qrcodeInstance = new QRCode(document.querySelector(".qrcode-generated"), {
                    text: url,
                    width: document.querySelector(".qrcode").getBoundingClientRect().width - 4,
                    height: document.querySelector(".qrcode").getBoundingClientRect().height - 4,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });
                document.querySelector(".qrcode-generated").style.display = "block";
                document.querySelector(".qrcode-default-image").style.display = "none";
            }
            catch (error) {
                alert("URL太長了，QRCode放不下");
                document.querySelector(".qrcode-generated").style.display = "none";
                document.querySelector(".qrcode-default-image").style.display = "block";
            }
        }
        else {
            qrcodeInstance.makeCode(url)
        }
    })

    document.querySelector(".content-ff-chooser").addEventListener("click", event => {
        event.stopPropagation();
        trySaveSettings();
        switch (event.target.value) {
            case "system-serif": {
                document.querySelector(".content-ff-custom-input").setAttribute("disabled", "disabled");
                document.querySelector("#content").style.fontFamily = "serif";
                break;
            }
            case "ming": {
                document.querySelector(".content-ff-custom-input").setAttribute("disabled", "disabled");
                document.querySelector("#content").style.fontFamily =
                    "'STSongti-TC-Light', NSimSun, PMingLiU, serif";
                break;
            }

            case "hei": {
                document.querySelector(".content-ff-custom-input").setAttribute("disabled", "disabled");
                document.querySelector("#content").style.fontFamily =
                    "'Hiragino Sans GB', 'Microsoft YaHei', STXihei, sans-serif";
                break;
            }
            case "kai": {
                document.querySelector(".content-ff-custom-input").setAttribute("disabled", "disabled");
                document.querySelector("#content").style.fontFamily =
                    "STKaiti, BiauKai, DFKai-SB, KaiTi, serif";
                break;
            }
            case "fangsong": {
                document.querySelector(".content-ff-custom-input").setAttribute("disabled", "disabled");
                document.querySelector("#content").style.fontFamily =
                    "STFangSong, FangSong_GB2312, FangSong, serif";
                break;
            }
            case "custom": {
                document.querySelector(".content-ff-custom-input").removeAttribute("disabled");
                document.querySelector("#content").style.fontFamily = document.querySelector(".content-ff-custom-input").value;
                break;
            }
            default: {
                document.querySelector("#content").style.fontFamily = "serif";
            }
        }
    });

    document.querySelector(".content-ff-custom-input").addEventListener("input", event => {
        document.querySelector("#content").style.fontFamily = event.target.value;
        trySaveSettings();
    });

    document.querySelector(".content-fs-input").addEventListener("input", event => {
        const size = Number(event.target.value) || 18;
        document.querySelector("#content").style.fontSize = `${size}px`;
        document.querySelector(".content-fs-auto-switch").checked = false;
    });

    function autoSetContentSize() {
        const target = document.querySelector("#content");
        const text = target.innerText;

        const size = Math.round(62 + -9.6 * Math.log(text.length));
        target.style.fontSize = `${size}px`;
        document.querySelector(".content-fs-input").value = size;
    }

    autoSetContentSize();

    document.querySelector(".content-fs-auto-switch").addEventListener("click", event => {
        if (event.target.checked) {
            autoSetContentSize();
        }
    })

    document.querySelector(".customization-switch").addEventListener("click", event => {
        document.querySelector('.customization-panel').classList.toggle("customizing");
    })


</script>
</body>
</html>
